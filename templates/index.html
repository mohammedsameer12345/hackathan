<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Intelligent Document Query System</title>
    <style>
        .spinner {
            display: none;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .thinking-text {
            text-align: center;
            font-style: italic;
            color: #555;
        }
    </style>
</head>
<body>
    <div>
        <h1>Intelligent Document Query System</h1>
        <p>LLM-Powered Document Analysis for Insurance, Legal, HR & Compliance</p>

        <div>
            <div>
                <h3>Multi-Format Support</h3>
                <p>PDF, DOCX, TXT files</p>
            </div>
            <div>
                <h3>Semantic Search</h3>
                <p>AI-powered content analysis</p>
            </div>
            <div>
                <h3>Clause Extraction</h3>
                <p>Relevant clause identification</p>
            </div>
            <div>
                <h3>Confidence Scoring</h3>
                <p>Accuracy assessment</p>
            </div>
        </div>

        <div>
            <h2>Document Upload</h2>
            <input type="file" id="file-upload" accept=".pdf,.docx,.txt">
            <p>Click to upload or drag and drop<br>Supports PDF, DOCX, and TXT files (Max 16MB)</p>
            <button onclick="uploadDocument()">Process Document</button>
        </div>

        <div id="processing" style="display: none;">
            <p>Processing your document...</p>
            <p>This may take a few moments depending on file size</p>
            <div class="spinner"></div>
        </div>

        <div id="analysis-result">
            <h2>Document Analysis</h2>
            <div id="analysis-content"></div>
            <div id="detailed-analysis-content"></div>
        </div>

        <div>
            <h2>Ask Questions About Your Document</h2>
            <div id="query-form">
                <label for="query-input">Your Question:</label>
                <input type="text" id="query-input">
                <label for="query-type">Query Type:</label>
                <select id="query-type">
                    <option value="general">General Query</option>
                    <option value="coverage">Coverage Analysis</option>
                    <option value="exclusions">Exclusions Check</option>
                    <option value="claims">Claims Process</option>
                    <option value="compliance">Legal Compliance</option>
                </select>
                <button onclick="submitQuery()">Get Answer</button>
            </div>
            <div id="query-spinner" class="spinner"></div>
            <p id="thinking-text" class="thinking-text" style="display: none;">AI is thinking...</p>
            <div id="query-result"></div>
        </div>

        <div>
            <h2>Analysis Results</h2>
            <div id="results-content"></div>
        </div>
    </div>

    <script>
        let documentText = '';
        let detailedAnalysis = {};
        let filename = '';

        function uploadDocument() {
            const fileInput = document.getElementById('file-upload');
            const file = fileInput.files[0];
            if (!file) {
                alert('Please select a file');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            document.getElementById('processing').style.display = 'block';
            document.getElementById('processing').querySelector('.spinner').style.display = 'block';

            fetch('/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('processing').style.display = 'none';
                if (data.success) {
                    documentText = data.document.text;
                    detailedAnalysis = data.document.detailed_analysis;
                    filename = data.document.filename;
                    displayAnalysis(data.document.analysis, data.document.detailed_analysis);
                } else {
                    alert(data.error);
                }
            })
            .catch(error => {
                document.getElementById('processing').style.display = 'none';
                alert('Error uploading document: ' + error);
            });
        }

        function displayAnalysis(simpleAnalysis, detailedAnalysis) {
            const analysisContent = document.getElementById('analysis-content');
            analysisContent.innerHTML = `
                <h3>Basic Analysis</h3>
                <p>Document Type: ${simpleAnalysis.document_type}</p>
                <p>Key Sections: ${simpleAnalysis.key_sections.join(', ')}</p>
                <p>Word Count: ${simpleAnalysis.word_count}</p>
                <p>Estimated Pages: ${simpleAnalysis.estimated_pages}</p>
                <p>Summary: ${simpleAnalysis.summary}</p>
            `;
            
            const detailedAnalysisContent = document.getElementById('detailed-analysis-content');
            detailedAnalysisContent.innerHTML = `
                <h3>Detailed Analysis</h3>
                <p>Document Type: ${detailedAnalysis.document_type}</p>
                <p>Key Sections: ${detailedAnalysis.key_sections.join(', ')}</p>
                ${detailedAnalysis.document_type === 'Insurance Policy' ? `
                    <p>Policy Type: ${detailedAnalysis.policy_type}</p>
                    <p>Coverage Details: ${detailedAnalysis.coverage_details.join(', ')}</p>
                    <p>Exclusions: ${detailedAnalysis.exclusions.join(', ')}</p>
                    <p>Claims Process: ${detailedAnalysis.claims_process.join(', ')}</p>
                    <p>Premium Info: ${detailedAnalysis.premium_info}</p>
                ` : ''}
            `;
        }

        function submitQuery() {
            const query = document.getElementById('query-input').value;
            const queryType = document.getElementById('query-type').value;

            if (!query) {
                alert('Please enter a question');
                return;
            }
            if (!documentText || !filename) {
                alert('Please upload a document first');
                return;
            }

            document.getElementById('query-spinner').style.display = 'block';
            document.getElementById('thinking-text').style.display = 'block';
            document.getElementById('query-result').innerHTML = '';

            fetch('/query', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    query: query,
                    document_text: documentText,
                    query_type: queryType,
                    detailed_analysis: detailedAnalysis,
                    filename: filename
                }),
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('query-spinner').style.display = 'none';
                document.getElementById('thinking-text').style.display = 'none';
                if (data.error) {
                    document.getElementById('query-result').innerHTML = `<p>Error: ${data.error}</p>`;
                } else {
                    document.getElementById('query-result').innerHTML = `
                        <p>Answer: ${data.answer}</p>
                        <p>Tokens Used: ${data.token_usage.total_tokens} (Input: ${data.token_usage.input_tokens}, Output: ${data.token_usage.output_tokens})</p>
                    `;
                }
            })
            .catch(error => {
                document.getElementById('query-spinner').style.display = 'none';
                document.getElementById('thinking-text').style.display = 'none';
                document.getElementById('query-result').innerHTML = `<p>Error: ${error}</p>`;
            });
        }
    </script>
</body>
</html>